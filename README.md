Micropython MH-Z19x CO2 EInk Logger
===================================

Work-in-progress project to put together a CO2 sensor device with timestamped
log of its measurements on a persistent EInk screen (or ePaper one actually).

Components involved:

- RPi-Pico-like rp2040 board running micropython firmware.
- [Winsen MH-Z19E NDIR CO2 Sensor], or any other MH-Z19 one.
- WaveShare 3-color (black-white-red) [2.13inch e-Paper HAT (B) V4] display.
- Analog Devices (ex Dallas Semiconductor) [DS3231 RTC] with a battery.

[Winsen MH-Z19E NDIR CO2 Sensor]:
  https://www.winsen-sensor.com/sensors/co2-sensor/mh-z19e.html
[2.13inch e-Paper HAT (B) V4]:
  https://www.waveshare.com/wiki/2.13inch_e-Paper_HAT_(B)_Manual
[DS3231 RTC]: https://www.analog.com/en/products/ds3231.html

Idea is an autonomous CO2 logger device, which can be enabled when/where needed
for a while to get a temporary log of results, easily visible on its screen even
after picking it up and disconnecting from power.
With measurements timestamped, to indicate/remind when they were taken,
but only persistent on the screen until its reset or next use.

Repository URLs:

- <https://github.com/mk-fg/mpy-mhz19-co2-eink-logger>
- <https://codeberg.org/mk-fg/mpy-mhz19-co2-eink-logger>
- <https://fraggod.net/code/git/mpy-mhz19-co2-eink-logger>


## How to use

It's basically one self-contained [main.py] micropython script,
using an ini configuration file with all sorts of parameters.

One possible wiring diagram for e.g. RPi Pico (rp2040) board,
and pins/interfaces from [config.example.ini] file:

![WireViz rp2040 wiring diagram][]

(generated by `wireviz -fp rp2040-wiring.yaml`
from [rp2040-wiring.yaml] file using [WireViz tool])

[main.py]: main.py
[config.example.ini]: config.example.ini
[rp2040-wiring.yaml]: rp2040-wiring.yaml
[WireViz rp2040 wiring diagram]:
  https://mk-fg.github.io/mpy-mhz19-co2-eink-logger/rp2040-wiring.png
[WireViz tool]: https://github.com/wireviz/WireViz/

Script itself can be run like this:

``` console
## Upload micropython firmware to the device, install "mpremote" tool

% cp config.example.ini config.ini
## Edit that config.ini file, to setup local device/network parameters

% mpremote cp config.ini :
% mpremote run main.py
## Should either work to print some errors to console

## To setup this to run on board boot
% mpremote cp main.py :
% mpremote reset
```

It can also run without sensor and/or screen using `test-fill`
and `test-export` config options (latter with [edp-png.py] helper script).
For example, with both of these enabled, to run the script and see
a png screencap of randomized data (to test layout or main code paths):

```
mpremote run main.py | tee test.b64
./edp-png.py -i test.b64 -o test.png && feh --zoom 400 test.png
```

(using common [feh] image viewer there at the end)

[edp-png.py]: edp-png.py
[feh]: https://wiki.archlinux.org/title/Feh


## Links

- [The Bible of MH-Z19x CO2 sensors] - great rundown of everything related
  to these devices (up to MH-Z19D variant), including all sorts of quirks.

- [WifWaf/MH-Z19 driver for MH-Z19x CO2 sensors] - not used here,
  but has a good amount of technical and protocol information and
  documentation on these devices, which datasheets lack.

[The Bible of MH-Z19x CO2 sensors]: https://emariete.com/en/sensor-co2-mh-z19b/
[WifWaf/MH-Z19 driver for MH-Z19x CO2 sensors]: https://github.com/WifWaf/MH-Z19


## TODO

- Finish leftover XXX not-implemented things in the code.

- Add option to set RTC, similar to an earlier rtc-test.py script.

    ```
    tt=`python -c 'import time; print((time.localtime()[:-1]))'` && \
    sed "s/tt_now = .*/tt_now = $tt/" rtc-test.py > /tmp/rtc-test.py && \
    mpremote a1 run /tmp/rtc-test.py
    ```

- Copy useful doc parts from [rp2040-sen5x-air-quality-webui-monitor project].

[rp2040-sen5x-air-quality-webui-monitor project]:
  https://github.com/mk-fg/rp2040-sen5x-air-quality-webui-monitor
